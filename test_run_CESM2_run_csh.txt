#!/bin/csh
# This script automatically download cesm2 
# Once the job is finished, it helps to submit the job

set run_time       = 01:50:00
set queue          = skx-normal
#set queue          = normal
set account        = TG-ATM190002
set run_start_date = "2003-01-02"
set pcount         = 1024

## ====================================================================
#   define case
## ====================================================================

setenv CCSMTAG     CESM
setenv CASE        CESM2_f19_v14_updated_NN_pelayout01_ens_07
#setenv CASESET     F_2000_SPCAM_sam1mom_SP 
setenv CASESET     HIST_CAM%SPCAMS_CLM50%SP_CICE%PRES_DOCN%DOM_RTM_SGLC_SWAV
setenv CASERES     f19_f19_mg17
setenv PROJECT     TG-ATM190002

## ====================================================================
#   define directories <Please make sure the directories are correct>
## ====================================================================

setenv MACH      stampede2-skx
#setenv MACH      stampede2-knl
setenv CCSMROOT  $HOME/repositories/$CCSMTAG
setenv CODEDIR   $HOME/repositories/CESM2-neuralnet-UCI
setenv CASEROOT  $SCRATCH/CESM2_case/$CASE
setenv PTMP      $SCRATCH/
setenv RUNDIR    $PTMP/$CASE/run
setenv ARCHDIR   $PTMP/archive/$CASE
setenv DATADIR   $SCRATCH/SPCAM_input

## ====================================================================
#   Download model source code <This part only need to do once>
## ====================================================================

#git clone -b release-cesm2.2.0 https://github.com/ESCOMP/CESM.git $CCSMROOT
#cd $CCSMROOT
#./manage_externals/checkout_externals
#./manage_externals/checkout_externals --logging
#git clone git@github.com:mspritch/CESM2-neuralnet-UCI.git $CODEDIR

## ====================================================================
#   create new case, configure, compile and run
## ====================================================================

rm -rf $CASEROOT
rm -rf $PTMP/$CASE

#------------------
## create new case
#------------------

cd $CCSMROOT/cime/scripts
cp $CODEDIR/pelayout* .

./create_newcase --case $CASEROOT --pecount $pcount --pesfile ./pelayout_01.xml --res $CASERES --machine $MACH --compset $CASESET --input-dir $DATADIR --output-root $CASEROOT --run-unsupported

cd  $CASEROOT

xmlchange --file env_batch.xml --id JOB_QUEUE --val $queue
xmlchange --file env_workflow.xml --id JOB_WALLCLOCK_TIME --val $run_time
xmlchange --file env_run.xml --id RUN_STARTDATE --val $run_start_date
xmlchange --file env_run.xml --id STOP_N --val 50
xmlchange --file env_run.xml --id run_data_archive --val "FALSE"
#xmlchange --file env_run.xml --id RESUBMIT --val 4

cat <<EOF >! user_nl_cam
npr_yz = 32,4,4,32
fincl2 = 'NN2L_DSTDRY4:A','NN2L_DSTWET4:A','NN2L_DSTDRY3:A','NN2L_DSTWET3:A','NN2L_DSTDRY2:A','NN2L_DSTWET2:A','NN2L_DSTDRY1:A','NN2L_DSTWET1:A','NN2L_OCPHODRY:A','NN2L_OCPHIDRY:A','NN2L_OCPHIWET:A','NN2L_BCPHODRY:A','NN2L_BCPHIDRY:A','NN2L_BCPHIWET:A','NN2L_PSL:A','NN2L_CO2DIAG:I','NN2L_CO2PROG:I','NN2L_THBOT:I','NN2L_SOLSD:I','NN2L_SOLLD:I','NN2L_SOLS:I','NN2L_SOLL:I','NN2L_PRECL:A','NN2L_PRECC:A','NN2L_PRECSL:A','NN2L_PRECSC:A','NN2L_FLWDS:I','NN2L_NETSW:I','NN2L_TBOT:A','NN2L_ZBOT:A','NN2L_UBOT:A','NN2L_VBOT:A','NN2L_QBOT:A','NN2L_PBOT:I','NN2L_RHO:I','T:I','Q:I','QAP:I','QBP:I','TBP:I','VAP:I','PS:I','SHFLX:I','LHFLX:I','PTTEND:I','PTEQ:I','SOLIN:I','FSNT:I','FSNS:I','FLNT:I','FLNS:I','U10:I','FLDS:I','FSDS:I','PRECT:I','CLDLIQAP:I','CLDICEAP:I','PTECLDLIQ:I','PTECLDICE:I','SPLIQICESTORAGE:I','SPICESTORAGE:I','SPTKE:I','SPTKES:I','SPQTFLX:I','SPQTFLXS:I','SPQPFLX:I','SPQPFLX:I','SPMC:I','SPMCUP:I','SPMCDN:I','PRECC:I','SPQPFLX:I','QRL:I','QRS:I','QRLC:I','QRSC:I','SPQC:I','SPQI:I','CLOUD:I','TBC:A', 'QBC:A', 'CLDLIQBC', 'CLDICEBC','RELHUM:I','CLDLIQBP','CLDICEBP'
nhtfrq = 0,1
mfilt  = 0,16
/
EOF

cat <<EOF >! user_nl_clm
&clmexp
/
EOF

cp $CODEDIR/*.F90 ./SourceMods/src.cam

./case.setup
./case.build
./case.submit

cd ..
end
